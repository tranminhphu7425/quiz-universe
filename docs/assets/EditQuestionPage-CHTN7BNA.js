import{c as I,w as re,r as d,j as e,L as ie,m as O,f as q}from"./index-BjqgGRGf.js";import{a as de,c as ce,u as oe,d as xe}from"./questionsApi-DaOOmmUc.js";import{f as me}from"./questionBanksApi-B-Rv64G5.js";import{C as he}from"./circle-check-BSR5RjDy.js";import{R}from"./refresh-ccw-C9sOiAjT.js";import{P as ue}from"./plus-BuJkqZbV.js";import{T as V}from"./trash-2-Ezvp-14-.js";const pe=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],ge=I("arrow-left",pe);const be=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],fe=I("save",be);const ye=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],ke=I("triangle-alert",ye),je=/\.{5,}/g;function M(r){const u=[];let x=0,m;for(;(m=je.exec(r))!==null;){const c=m.index;c>x&&u.push({type:"text",text:r.slice(x,c)}),u.push({type:"blank"}),x=c+m[0].length}return x<r.length&&u.push({type:"text",text:r.slice(x)}),u.length?u:[{type:"text",text:r}]}function b(r){return structuredClone?structuredClone(r):JSON.parse(JSON.stringify(r))}const Ne="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");function y(r){return Ne[r]||`Opt${r+1}`}function qe(){const{subjectId:r}=re(),[u,x]=d.useState(!0),[m,c]=d.useState(null),[z,D]=d.useState(""),[g,k]=d.useState([]),[j,L]=d.useState(1),w=10,[h,f]=d.useState(null),[s,i]=d.useState(null),[C,E]=d.useState(!1),[Q,p]=d.useState(null),$=d.useRef(null),[N,A]=d.useState(!1),[X,T]=d.useState(!1);d.useEffect(()=>{if(!r)return;let t=!1;return x(!0),c(null),(async()=>{try{const a=Number(r),[n,l]=await Promise.all([de(a),me(a).catch(()=>({name:`Môn #${a}`}))]);t||(k(n),D(l?.name||`Môn #${a}`),n.length&&(f(n[0].id),i(b(n[0]))))}catch(a){t||c(a?.message||"Không tải được dữ liệu.")}finally{t||x(!1)}})(),()=>{t=!0}},[r]);const S=g.length,_=Math.max(1,Math.ceil(S/w)),v=(j-1)*w,H=Math.min(S,v+w),K=g.slice(v,H);function F(t){f(t.id),i(b(t)),p(null),setTimeout(()=>$.current?.scrollIntoView({behavior:"smooth",block:"start"}),0)}function G(t){if(!s)return;const a={...s,stem:t};i(a)}function J(t){s&&i({...s,explanation:t})}function P(t){s&&i({...s,questionType:t})}function Z(){if(!s)return;const t=(s.options||[]).slice().sort((l,o)=>(l.sortOrder??0)-(o.sortOrder??0)),a=t.length,n={id:Math.floor(Math.random()*1e9)*-1,questionId:s.id,label:y(a),content:"",isCorrect:s.questionType==="mcq_single"?a===0:!1,sortOrder:a+1};i({...s,options:[...t,n]})}function U(t,a){if(!t)return null;const n=a.findIndex(l=>l.id===t);return n>=0?n+1:null}const B=d.useMemo(()=>U(h,g),[h,g]);function W(t){if(!s)return;const n=(s.options||[]).filter(l=>l.id!==t).slice().sort((l,o)=>(l.sortOrder??0)-(o.sortOrder??0)).map((l,o)=>({...l,label:y(o),sortOrder:o+1}));i({...s,options:n})}function Y(t,a){if(!s)return;const n=(s.options||[]).map(l=>l.id===t?{...l,...a}:l);i({...s,options:n})}function ee(t){if(!s||s.questionType!=="mcq_single")return;const a=(s.options||[]).map(n=>({...n,isCorrect:n.id===t}));i({...s,options:a})}function te(){if(!s)return;const t=M(s.stem).filter(n=>n.type==="blank").length;let a=(s.options||[]).slice().sort((n,l)=>(n.sortOrder??0)-(l.sortOrder??0));for(;a.length<t;){const n=a.length;a.push({id:Math.floor(Math.random()*1e9)*-1,questionId:s.id,label:y(n),content:"",isCorrect:!1,sortOrder:n+1})}a.length>t&&(a=a.slice(0,t)),a=a.map((n,l)=>({...n,label:y(l),sortOrder:l+1})),i({...s,options:a})}function se(){if(!s)return"Không có dữ liệu để lưu.";if(!s.stem?.trim())return"Vui lòng nhập nội dung câu hỏi (stem).";const t=(s.options||[]).slice();if(s.questionType==="mcq_single"){if(t.length<2)return"Cần ít nhất 2 lựa chọn cho câu trắc nghiệm.";if(t.filter(n=>n.isCorrect).length!==1)return"Câu trắc nghiệm phải có đúng 1 đáp án đúng."}if(s.questionType==="fill_in"){const a=M(s.stem).filter(n=>n.type==="blank").length;if(a===0)return"Câu điền khuyết cần có ít nhất 1 ô trống (gõ ≥ 6 dấu chấm).";if(t.length!==a)return`Số đáp án (${t.length}) chưa khớp số ô trống (${a}). Bấm "Đồng bộ ô trống".`;if(t.some(n=>!String(n.content||"").trim()))return"Mỗi ô trống cần cung cấp đáp án đúng (có thể nhiều phương án, ngăn bởi dấu |)."}return null}async function ae(){try{const t=await ce(Number(r),{stem:"",explanation:"",questionType:"mcq_single",options:[]});k(a=>[...a,t]),f(t.id),i(b(t))}catch(t){c(t?.message||"Không tạo được câu hỏi mới.")}}async function ne(){const t=se();if(t){p(null),c(t);return}if(s){E(!0),c(null),p(null);try{const a={stem:s.stem,explanation:s.explanation??null,questionType:s.questionType,options:(s.options||[]).slice().sort((l,o)=>(l.sortOrder??0)-(o.sortOrder??0)).map(l=>({id:l.id>0?l.id:void 0,label:l.label,content:l.content,isCorrect:!!l.isCorrect,sortOrder:l.sortOrder}))},n=await oe(s.id,a);k(l=>l.map(o=>o.id===n.id?n:o)),i(b(n)),p("Đã lưu thay đổi.")}catch(a){c(a?.message||"Lưu thất bại.")}finally{E(!1),setTimeout(()=>p(null),2500)}}}async function le(){if(!(!s||!h)){A(!0),c(null);try{await xe(h);const t=g.filter(a=>a.id!==h);if(k(t),t.length>0){const a=t[0];f(a.id),i(b(a))}else f(null),i(null);T(!1),p("Đã xóa câu hỏi thành công."),setTimeout(()=>p(null),2500)}catch(t){c(t?.message||"Xóa thất bại. Vui lòng thử lại.")}finally{A(!1)}}}return e.jsxs("div",{className:"min-h-screen bg-slate-50 dark:bg-slate-900",children:[e.jsxs("section",{className:"relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-600 via-green-600 to-emerald-500 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900"}),e.jsxs("div",{className:"relative z-10 mx-auto flex max-w-7xl flex-col gap-4 px-6 py-10 text-white md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-2 inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold ring-1 ring-white/20 backdrop-blur",children:"Trình chỉnh sửa câu hỏi"}),e.jsxs("h1",{className:"text-[1.9rem] md:text-[2.4rem] font-black leading-tight",children:["Sửa câu hỏi môn ",e.jsx("span",{className:"bg-gradient-to-r from-purple-300 to-amber-200 bg-clip-text text-transparent",children:z})]}),e.jsx("div",{ref:$})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs(ie,{to:`/questions/subject/${r}`,className:"inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm ring-1 ring-white/20 hover:bg-white/15",children:[e.jsx(ge,{className:"h-4 w-4"}),"Về trang làm bài"]})})]})]}),X&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:e.jsxs(O.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"w-full max-w-md rounded-2xl bg-white p-6 shadow-xl dark:bg-slate-900",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[e.jsx("div",{className:"rounded-full bg-rose-100 p-2 dark:bg-rose-900/30",children:e.jsx(ke,{className:"h-6 w-6 text-rose-600 dark:text-rose-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:"Xác nhận xóa"})]}),e.jsx("p",{className:"mb-6 text-slate-600 dark:text-slate-300",children:"Bạn có chắc chắn muốn xóa câu hỏi này? Hành động này không thể hoàn tác."}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:()=>T(!1),className:"rounded-lg px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800",disabled:N,children:"Hủy"}),e.jsx("button",{type:"button",onClick:le,disabled:N,className:"rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white hover:bg-rose-700 disabled:opacity-70",children:N?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"mr-2 inline h-4 w-4 animate-spin"}),"Đang xóa..."]}):"Xác nhận xóa"})]})]})}),e.jsxs("main",{className:"mx-auto grid max-w-7xl grid-cols-1 gap-6 px-6 py-8 md:grid-cols-[minmax(280px,360px)_1fr]",children:[e.jsxs(O.aside,{initial:{opacity:0,x:-8},animate:{opacity:1,x:0},transition:{type:"spring",stiffness:140,damping:18},className:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-slate-200",children:"Danh sách câu hỏi"}),e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:[S," câu"]})]}),u?e.jsxs("div",{className:"flex items-center gap-2 text-slate-500",children:[e.jsx(q,{className:"h-4 w-4 animate-spin"}),"Đang tải…"]}):m?e.jsx("div",{className:"rounded-lg bg-rose-50 p-3 text-sm text-rose-700 ring-1 ring-rose-200 dark:bg-rose-900/20 dark:text-rose-300 dark:ring-rose-800",children:m}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-auto pr-1",children:e.jsx("ol",{className:"space-y-2",children:K.map((t,a)=>{const n=v+a+1,l=t.id===h;return e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>F(t),className:`w-full rounded-xl border px-3 py-2 text-left text-sm transition ${l?"border-emerald-400 bg-emerald-50 ring-1 ring-emerald-300 dark:border-emerald-700 dark:bg-emerald-900/20 dark:ring-emerald-800":"border-slate-200 hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800"}`,title:`Sửa câu ${n}`,children:[e.jsxs("div",{className:"mb-1 flex items-center gap-2 text-[13px] font-semibold text-slate-700 dark:text-slate-200",children:[e.jsx("span",{className:"inline-flex h-5 w-5 items-center justify-center rounded-md bg-slate-100 text-xs text-slate-700 dark:bg-slate-800 dark:text-slate-300",children:n}),e.jsx("span",{className:"truncate",children:t.stem})]}),e.jsx("div",{className:"text-[12px] text-slate-500 dark:text-slate-400",children:t.questionType==="fill_in"?"Điền khuyết":"Trắc nghiệm"})]})},t.id)})})}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("button",{onClick:()=>L(t=>Math.max(1,t-1)),disabled:j===1,className:"rounded-md border border-slate-200 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800",children:"← Trước"}),e.jsxs("div",{className:"text-xs text-slate-600 dark:text-slate-300",children:["Trang ",e.jsx("b",{children:j}),"/        ",e.jsx("b",{children:_})," • Câu ",e.jsx("b",{children:v+1}),"–        ",e.jsx("b",{children:H})]}),e.jsx("button",{onClick:()=>L(t=>Math.min(_,t+1)),disabled:j===_,className:"ml-auto rounded-md border border-slate-200 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800",children:"Sau →"})]})]})]}),e.jsx(O.section,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{type:"spring",stiffness:140,damping:18},className:"rounded-2xl border border-emerald-100 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900",children:s?e.jsxs("form",{className:"space-y-5",onSubmit:t=>{t.preventDefault(),ne()},children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"text-sm font-semibold text-slate-700 dark:text-slate-200",children:["Câu ",B!==null?`${B}`:"Chưa chọn"]}),Q&&e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2 py-1 text-xs text-emerald-700 ring-1 ring-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-300 dark:ring-emerald-800",children:[e.jsx(he,{className:"h-3.5 w-3.5"}),Q]}),m&&e.jsx("span",{className:"inline-flex items-center gap-1 rounded-full bg-rose-100 px-2 py-1 text-xs text-rose-700 ring-1 ring-rose-200 dark:bg-rose-900/30 dark:text-rose-300 dark:ring-rose-800",children:m})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Loại câu hỏi"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200",children:[e.jsx("input",{type:"radio",name:"type",value:"mcq_single",checked:s.questionType==="mcq_single",onChange:()=>P("mcq_single"),className:"h-4 w-4 accent-emerald-700"}),"Trắc nghiệm 1 đáp án đúng"]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200",children:[e.jsx("input",{type:"radio",name:"type",value:"fill_in",checked:s.questionType==="fill_in",onChange:()=>P("fill_in"),className:"h-4 w-4 accent-emerald-700"}),"Điền khuyết (….. = ô trống)"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Nội dung câu hỏi (Stem)"}),e.jsx("textarea",{value:s.stem,onChange:t=>G(t.target.value),rows:3,className:"w-full resize-y rounded-xl border border-slate-300 bg-white p-3 text-sm outline-none ring-emerald-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100",placeholder:s.questionType==="fill_in"?"Ví dụ: 1 + ….. = ….. (dùng ≥ 6 dấu chấm để tạo ô trống)":"Nhập câu hỏi"}),s.questionType==="fill_in"&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-slate-600 dark:text-slate-400",children:["Có ",e.jsx("b",{className:"mx-1",children:M(s.stem).filter(t=>t.type==="blank").length})," ô trống.",e.jsxs("button",{type:"button",onClick:te,className:"inline-flex items-center gap-1 rounded-md border px-2 py-1 text-[12px] hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800",children:[e.jsx(R,{className:"h-3.5 w-3.5"}),"Đồng bộ ô trống"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Giải thích (tuỳ chọn)"}),e.jsx("textarea",{value:s.explanation||"",onChange:t=>J(t.target.value),rows:3,className:"w-full resize-y rounded-xl border border-slate-300 bg-white p-3 text-sm outline-none ring-emerald-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100",placeholder:"Nhập giải thích/ghi chú cho câu hỏi"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Phương án trả lời"}),e.jsxs("button",{type:"button",onClick:Z,className:"dark:text-slate-200 inline-flex items-center gap-1 rounded-md border px-2 py-1 text-sm hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800",children:[e.jsx(ue,{className:"h-4 w-4 "}),"Thêm lựa chọn"]})]}),e.jsx("div",{className:"space-y-2",children:(s.options||[]).slice().sort((t,a)=>(t.sortOrder??0)-(a.sortOrder??0)).map((t,a)=>e.jsxs("div",{className:"flex items-start gap-2 rounded-xl border border-slate-200 p-3 dark:border-slate-800",children:[e.jsx("div",{className:"mt-1 inline-flex h-6 w-6 items-center justify-center rounded-md bg-slate-100 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-300",children:t.label||y(a)}),e.jsxs("div",{className:"grid flex-1 gap-2 md:grid-cols-[1fr_auto]",children:[e.jsx("input",{type:"text",value:t.content||"",onChange:n=>Y(t.id,{content:n.target.value}),placeholder:s.questionType==="fill_in"?'Đáp án đúng cho ô này (có thể "a|b|c")':"Nội dung phương án",className:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm outline-none ring-emerald-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100"}),s.questionType==="mcq_single"?e.jsxs("label",{className:"inline-flex items-center justify-end gap-2 text-sm text-slate-700 dark:text-slate-200",children:[e.jsx("input",{type:"radio",name:"correct",checked:!!t.isCorrect,onChange:()=>ee(t.id),className:"h-4 w-4 accent-emerald-700"}),"Đúng"]}):e.jsx("div",{className:"text-right text-[12px] text-slate-500 dark:text-slate-400 self-center",children:"(Tự động chấm theo văn bản)"})]}),e.jsx("button",{type:"button",onClick:()=>W(t.id),className:"rounded-md p-2 text-slate-500 hover:bg-slate-100 hover:text-rose-600 dark:hover:bg-slate-800",title:"Xoá",children:e.jsx(V,{className:"h-4 w-4"})})]},t.id))}),s.questionType==="fill_in"&&e.jsxs("p",{className:"mt-2 text-[12px] text-slate-600 dark:text-slate-400",children:["Mẹo: Cho phép nhiều đáp án cho một ô bằng dấu ",e.jsx("code",{className:"rounded bg-slate-100 px-1 dark:bg-slate-800",children:"|"}),", ví dụ: ",e.jsx("code",{className:"rounded bg-slate-100 px-1 dark:bg-slate-800",children:'"Hà Nội|Ha Noi"'}),"."]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("button",{type:"submit",disabled:C,className:"inline-flex items-center gap-2 rounded-full bg-emerald-600 px-5 py-2.5 text-white shadow hover:brightness-110 disabled:opacity-70",children:[C?e.jsx(q,{className:"h-4 w-4 animate-spin"}):e.jsx(fe,{className:"h-4 w-4"})," ","Lưu thay đổi"]}),e.jsxs("button",{type:"button",onClick:()=>s?i(b(g.find(t=>t.id===s.id))):null,className:"inline-flex items-center gap-2 rounded-full bg-slate-800 px-5 py-2.5 text-white shadow hover:brightness-110 dark:bg-slate-700",children:[e.jsx(R,{className:"h-4 w-4"}),"Hoàn tác"]}),h&&h>0&&e.jsxs("button",{type:"button",onClick:()=>T(!0),disabled:N||C,className:"inline-flex items-center gap-2 rounded-full bg-rose-600 px-5 py-2.5 text-white shadow hover:bg-rose-700 disabled:opacity-70",children:[e.jsx(V,{className:"h-4 w-4"}),"Xóa câu hỏi"]})]}),e.jsx("button",{type:"button",onClick:()=>ae(),className:"inline-flex items-center gap-2 rounded-full bg-yellow-500 px-5 py-2.5 text-white shadow hover:brightness-110 dark:bg-yellow-600",children:"Tạo thêm câu hỏi"})]})]}):e.jsx("div",{className:"text-slate-600 dark:text-slate-300",children:"Chọn một câu ở danh sách bên trái để chỉnh sửa."})})]})]})}export{qe as default};
