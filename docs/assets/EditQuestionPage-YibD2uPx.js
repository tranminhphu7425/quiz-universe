import{c as le,v as re,r as d,Q as ie,j as e,L as de,m as _,f as q}from"./index-DeFSDhfv.js";import{a as oe,c as ce,u as xe,d as me}from"./questionsApi-JuFiAF-X.js";import{A as he}from"./arrow-left-CLJvNsof.js";import{C as ue}from"./circle-check-C_8fpDfg.js";import{R as $}from"./refresh-ccw-BtpW0bbv.js";import{P as pe}from"./plus-D4zyNoE-.js";import{T as D}from"./trash-2-DULxah7N.js";import{S as ge}from"./save-C4AHGIFn.js";const be=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],fe=le("triangle-alert",be),ke=/\.{5,}/g;function I(r){const u=[];let x=0,m;for(;(m=ke.exec(r))!==null;){const o=m.index;o>x&&u.push({type:"text",text:r.slice(x,o)}),u.push({type:"blank"}),x=o+m[0].length}return x<r.length&&u.push({type:"text",text:r.slice(x)}),u.length?u:[{type:"text",text:r}]}function b(r){return structuredClone?structuredClone(r):JSON.parse(JSON.stringify(r))}const ye="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");function k(r){return ye[r]||`Opt${r+1}`}function _e(){const{bankId:r}=re(),[u,x]=d.useState(!0),[m,o]=d.useState(null),[H,V]=d.useState(""),[g,y]=d.useState([]),[j,M]=d.useState(1),w=10,[h,f]=d.useState(null),[s,i]=d.useState(null),[C,L]=d.useState(!1),[E,p]=d.useState(null),Q=d.useRef(null),[N,A]=d.useState(!1),[X,T]=d.useState(!1);d.useEffect(()=>{if(!r)return;let t=!1;return x(!0),o(null),(async()=>{try{const n=Number(r),[a,l]=await Promise.all([oe(n),ie.getById(n)]);t||(y(a),V(l?.name||`Môn #${n}`),a.length&&(f(a[0].id),i(b(a[0]))))}catch(n){t||o(n?.message||"Không tải được dữ liệu.")}finally{t||x(!1)}})(),()=>{t=!0}},[r]);const S=g.length,O=Math.max(1,Math.ceil(S/w)),v=(j-1)*w,P=Math.min(S,v+w),z=g.slice(v,P);function K(t){f(t.id),i(b(t)),p(null),setTimeout(()=>Q.current?.scrollIntoView({behavior:"smooth",block:"start"}),0)}function F(t){if(!s)return;const n={...s,stem:t};i(n)}function G(t){s&&i({...s,explanation:t})}function B(t){s&&i({...s,questionType:t})}function J(){if(!s)return;const t=(s.options||[]).slice().sort((l,c)=>(l.sortOrder??0)-(c.sortOrder??0)),n=t.length,a={id:Math.floor(Math.random()*1e9)*-1,questionId:s.id,label:k(n),content:"",isCorrect:s.questionType==="mcq_single"?n===0:!1,sortOrder:n+1};i({...s,options:[...t,a]})}function Z(t,n){if(!t)return null;const a=n.findIndex(l=>l.id===t);return a>=0?a+1:null}const R=d.useMemo(()=>Z(h,g),[h,g]);function U(t){if(!s)return;const a=(s.options||[]).filter(l=>l.id!==t).slice().sort((l,c)=>(l.sortOrder??0)-(c.sortOrder??0)).map((l,c)=>({...l,label:k(c),sortOrder:c+1}));i({...s,options:a})}function W(t,n){if(!s)return;const a=(s.options||[]).map(l=>l.id===t?{...l,...n}:l);i({...s,options:a})}function Y(t){if(!s||s.questionType!=="mcq_single")return;const n=(s.options||[]).map(a=>({...a,isCorrect:a.id===t}));i({...s,options:n})}function ee(){if(!s)return;const t=I(s.stem).filter(a=>a.type==="blank").length;let n=(s.options||[]).slice().sort((a,l)=>(a.sortOrder??0)-(l.sortOrder??0));for(;n.length<t;){const a=n.length;n.push({id:Math.floor(Math.random()*1e9)*-1,questionId:s.id,label:k(a),content:"",isCorrect:!1,sortOrder:a+1})}n.length>t&&(n=n.slice(0,t)),n=n.map((a,l)=>({...a,label:k(l),sortOrder:l+1})),i({...s,options:n})}function te(){if(!s)return"Không có dữ liệu để lưu.";if(!s.stem?.trim())return"Vui lòng nhập nội dung câu hỏi (stem).";const t=(s.options||[]).slice();if(s.questionType==="mcq_single"){if(t.length<2)return"Cần ít nhất 2 lựa chọn cho câu trắc nghiệm.";if(t.filter(a=>a.isCorrect).length!==1)return"Câu trắc nghiệm phải có đúng 1 đáp án đúng."}if(s.questionType==="fill_in"){const n=I(s.stem).filter(a=>a.type==="blank").length;if(n===0)return"Câu điền khuyết cần có ít nhất 1 ô trống (gõ ≥ 6 dấu chấm).";if(t.length!==n)return`Số đáp án (${t.length}) chưa khớp số ô trống (${n}). Bấm "Đồng bộ ô trống".`;if(t.some(a=>!String(a.content||"").trim()))return"Mỗi ô trống cần cung cấp đáp án đúng (có thể nhiều phương án, ngăn bởi dấu |)."}return null}async function se(){try{const t=await ce(Number(r),{stem:"",explanation:"",questionType:"mcq_single",options:[]});y(n=>[...n,t]),f(t.id),i(b(t))}catch(t){o(t?.message||"Không tạo được câu hỏi mới.")}}async function ne(){const t=te();if(t){p(null),o(t);return}if(s){L(!0),o(null),p(null);try{const n={stem:s.stem,explanation:s.explanation??null,questionType:s.questionType,options:(s.options||[]).slice().sort((l,c)=>(l.sortOrder??0)-(c.sortOrder??0)).map(l=>({id:l.id>0?l.id:void 0,label:l.label,content:l.content,isCorrect:!!l.isCorrect,sortOrder:l.sortOrder}))},a=await xe(s.id,n);y(l=>l.map(c=>c.id===a.id?a:c)),i(b(a)),p("Đã lưu thay đổi.")}catch(n){o(n?.message||"Lưu thất bại.")}finally{L(!1),setTimeout(()=>p(null),2500)}}}async function ae(){if(!(!s||!h)){A(!0),o(null);try{await me(h);const t=g.filter(n=>n.id!==h);if(y(t),t.length>0){const n=t[0];f(n.id),i(b(n))}else f(null),i(null);T(!1),p("Đã xóa câu hỏi thành công."),setTimeout(()=>p(null),2500)}catch(t){o(t?.message||"Xóa thất bại. Vui lòng thử lại.")}finally{A(!1)}}}return e.jsxs("div",{className:"min-h-screen bg-slate-50 dark:bg-slate-900",children:[e.jsxs("section",{className:"relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-600 via-green-600 to-emerald-500 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900"}),e.jsxs("div",{className:"relative z-10 mx-auto flex max-w-7xl flex-col gap-4 px-6 py-10 text-white md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-2 inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold ring-1 ring-white/20 backdrop-blur",children:"Trình chỉnh sửa câu hỏi"}),e.jsxs("h1",{className:"text-[1.9rem] md:text-[2.4rem] font-black leading-tight",children:["Sửa câu hỏi môn ",e.jsx("span",{className:"bg-gradient-to-r from-purple-300 to-amber-200 bg-clip-text text-transparent",children:H})]}),e.jsx("div",{ref:Q})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs(de,{to:`/questions/subject/${r}`,className:"inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm ring-1 ring-white/20 hover:bg-white/15",children:[e.jsx(he,{className:"h-4 w-4"}),"Về trang làm bài"]})})]})]}),X&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:e.jsxs(_.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"w-full max-w-md rounded-2xl bg-white p-6 shadow-xl dark:bg-slate-900",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[e.jsx("div",{className:"rounded-full bg-rose-100 p-2 dark:bg-rose-900/30",children:e.jsx(fe,{className:"h-6 w-6 text-rose-600 dark:text-rose-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:"Xác nhận xóa"})]}),e.jsx("p",{className:"mb-6 text-slate-600 dark:text-slate-300",children:"Bạn có chắc chắn muốn xóa câu hỏi này? Hành động này không thể hoàn tác."}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:()=>T(!1),className:"rounded-lg px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800",disabled:N,children:"Hủy"}),e.jsx("button",{type:"button",onClick:ae,disabled:N,className:"rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white hover:bg-rose-700 disabled:opacity-70",children:N?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"mr-2 inline h-4 w-4 animate-spin"}),"Đang xóa..."]}):"Xác nhận xóa"})]})]})}),e.jsxs("main",{className:"mx-auto grid max-w-7xl grid-cols-1 gap-6 px-6 py-8 md:grid-cols-[minmax(280px,360px)_1fr]",children:[e.jsxs(_.aside,{initial:{opacity:0,x:-8},animate:{opacity:1,x:0},transition:{type:"spring",stiffness:140,damping:18},className:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-slate-200",children:"Danh sách câu hỏi"}),e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:[S," câu"]})]}),u?e.jsxs("div",{className:"flex items-center gap-2 text-slate-500",children:[e.jsx(q,{className:"h-4 w-4 animate-spin"}),"Đang tải…"]}):m?e.jsx("div",{className:"rounded-lg bg-rose-50 p-3 text-sm text-rose-700 ring-1 ring-rose-200 dark:bg-rose-900/20 dark:text-rose-300 dark:ring-rose-800",children:m}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-auto pr-1",children:e.jsx("ol",{className:"space-y-2",children:z.map((t,n)=>{const a=v+n+1,l=t.id===h;return e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>K(t),className:`w-full rounded-xl border px-3 py-2 text-left text-sm transition ${l?"border-emerald-400 bg-emerald-50 ring-1 ring-emerald-300 dark:border-emerald-700 dark:bg-emerald-900/20 dark:ring-emerald-800":"border-slate-200 hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800"}`,title:`Sửa câu ${a}`,children:[e.jsxs("div",{className:"mb-1 flex items-center gap-2 text-[13px] font-semibold text-slate-700 dark:text-slate-200",children:[e.jsx("span",{className:"inline-flex h-5 w-5 items-center justify-center rounded-md bg-slate-100 text-xs text-slate-700 dark:bg-slate-800 dark:text-slate-300",children:a}),e.jsx("span",{className:"truncate",children:t.stem})]}),e.jsx("div",{className:"text-[12px] text-slate-500 dark:text-slate-400",children:t.questionType==="fill_in"?"Điền khuyết":"Trắc nghiệm"})]})},t.id)})})}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("button",{onClick:()=>M(t=>Math.max(1,t-1)),disabled:j===1,className:"rounded-md border border-slate-200 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800",children:"← Trước"}),e.jsxs("div",{className:"text-xs text-slate-600 dark:text-slate-300",children:["Trang ",e.jsx("b",{children:j}),"/        ",e.jsx("b",{children:O})," • Câu ",e.jsx("b",{children:v+1}),"–        ",e.jsx("b",{children:P})]}),e.jsx("button",{onClick:()=>M(t=>Math.min(O,t+1)),disabled:j===O,className:"ml-auto rounded-md border border-slate-200 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800",children:"Sau →"})]})]})]}),e.jsx(_.section,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{type:"spring",stiffness:140,damping:18},className:"rounded-2xl border border-emerald-100 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900",children:s?e.jsxs("form",{className:"space-y-5",onSubmit:t=>{t.preventDefault(),ne()},children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"text-sm font-semibold text-slate-700 dark:text-slate-200",children:["Câu ",R!==null?`${R}`:"Chưa chọn"]}),E&&e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2 py-1 text-xs text-emerald-700 ring-1 ring-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-300 dark:ring-emerald-800",children:[e.jsx(ue,{className:"h-3.5 w-3.5"}),E]}),m&&e.jsx("span",{className:"inline-flex items-center gap-1 rounded-full bg-rose-100 px-2 py-1 text-xs text-rose-700 ring-1 ring-rose-200 dark:bg-rose-900/30 dark:text-rose-300 dark:ring-rose-800",children:m})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Loại câu hỏi"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200",children:[e.jsx("input",{type:"radio",name:"type",value:"mcq_single",checked:s.questionType==="mcq_single",onChange:()=>B("mcq_single"),className:"h-4 w-4 accent-emerald-700"}),"Trắc nghiệm 1 đáp án đúng"]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200",children:[e.jsx("input",{type:"radio",name:"type",value:"fill_in",checked:s.questionType==="fill_in",onChange:()=>B("fill_in"),className:"h-4 w-4 accent-emerald-700"}),"Điền khuyết (….. = ô trống)"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Nội dung câu hỏi (Stem)"}),e.jsx("textarea",{value:s.stem,onChange:t=>F(t.target.value),rows:3,className:"w-full resize-y rounded-xl border border-slate-300 bg-white p-3 text-sm outline-none ring-emerald-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100",placeholder:s.questionType==="fill_in"?"Ví dụ: 1 + ….. = ….. (dùng ≥ 6 dấu chấm để tạo ô trống)":"Nhập câu hỏi"}),s.questionType==="fill_in"&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-slate-600 dark:text-slate-400",children:["Có ",e.jsx("b",{className:"mx-1",children:I(s.stem).filter(t=>t.type==="blank").length})," ô trống.",e.jsxs("button",{type:"button",onClick:ee,className:"inline-flex items-center gap-1 rounded-md border px-2 py-1 text-[12px] hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800",children:[e.jsx($,{className:"h-3.5 w-3.5"}),"Đồng bộ ô trống"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Giải thích (tuỳ chọn)"}),e.jsx("textarea",{value:s.explanation||"",onChange:t=>G(t.target.value),rows:3,className:"w-full resize-y rounded-xl border border-slate-300 bg-white p-3 text-sm outline-none ring-emerald-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100",placeholder:"Nhập giải thích/ghi chú cho câu hỏi"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Phương án trả lời"}),e.jsxs("button",{type:"button",onClick:J,className:"dark:text-slate-200 inline-flex items-center gap-1 rounded-md border px-2 py-1 text-sm hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800",children:[e.jsx(pe,{className:"h-4 w-4 "}),"Thêm lựa chọn"]})]}),e.jsx("div",{className:"space-y-2",children:(s.options||[]).slice().sort((t,n)=>(t.sortOrder??0)-(n.sortOrder??0)).map((t,n)=>e.jsxs("div",{className:"flex items-start gap-2 rounded-xl border border-slate-200 p-3 dark:border-slate-800",children:[e.jsx("div",{className:"mt-1 inline-flex h-6 w-6 items-center justify-center rounded-md bg-slate-100 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-300",children:t.label||k(n)}),e.jsxs("div",{className:"grid flex-1 gap-2 md:grid-cols-[1fr_auto]",children:[e.jsx("input",{type:"text",value:t.content||"",onChange:a=>W(t.id,{content:a.target.value}),placeholder:s.questionType==="fill_in"?'Đáp án đúng cho ô này (có thể "a|b|c")':"Nội dung phương án",className:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm outline-none ring-emerald-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100"}),s.questionType==="mcq_single"?e.jsxs("label",{className:"inline-flex items-center justify-end gap-2 text-sm text-slate-700 dark:text-slate-200",children:[e.jsx("input",{type:"radio",name:"correct",checked:!!t.isCorrect,onChange:()=>Y(t.id),className:"h-4 w-4 accent-emerald-700"}),"Đúng"]}):e.jsx("div",{className:"text-right text-[12px] text-slate-500 dark:text-slate-400 self-center",children:"(Tự động chấm theo văn bản)"})]}),e.jsx("button",{type:"button",onClick:()=>U(t.id),className:"rounded-md p-2 text-slate-500 hover:bg-slate-100 hover:text-rose-600 dark:hover:bg-slate-800",title:"Xoá",children:e.jsx(D,{className:"h-4 w-4"})})]},t.id))}),s.questionType==="fill_in"&&e.jsxs("p",{className:"mt-2 text-[12px] text-slate-600 dark:text-slate-400",children:["Mẹo: Cho phép nhiều đáp án cho một ô bằng dấu ",e.jsx("code",{className:"rounded bg-slate-100 px-1 dark:bg-slate-800",children:"|"}),", ví dụ: ",e.jsx("code",{className:"rounded bg-slate-100 px-1 dark:bg-slate-800",children:'"Hà Nội|Ha Noi"'}),"."]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("button",{type:"submit",disabled:C,className:"inline-flex items-center gap-2 rounded-full bg-emerald-600 px-5 py-2.5 text-white shadow hover:brightness-110 disabled:opacity-70",children:[C?e.jsx(q,{className:"h-4 w-4 animate-spin"}):e.jsx(ge,{className:"h-4 w-4"})," ","Lưu thay đổi"]}),e.jsxs("button",{type:"button",onClick:()=>s?i(b(g.find(t=>t.id===s.id))):null,className:"inline-flex items-center gap-2 rounded-full bg-slate-800 px-5 py-2.5 text-white shadow hover:brightness-110 dark:bg-slate-700",children:[e.jsx($,{className:"h-4 w-4"}),"Hoàn tác"]}),h&&h>0&&e.jsxs("button",{type:"button",onClick:()=>T(!0),disabled:N||C,className:"inline-flex items-center gap-2 rounded-full bg-rose-600 px-5 py-2.5 text-white shadow hover:bg-rose-700 disabled:opacity-70",children:[e.jsx(D,{className:"h-4 w-4"}),"Xóa câu hỏi"]})]}),e.jsx("button",{type:"button",onClick:()=>se(),className:"inline-flex items-center gap-2 rounded-full bg-yellow-500 px-5 py-2.5 text-white shadow hover:brightness-110 dark:bg-yellow-600",children:"Tạo thêm câu hỏi"})]})]}):e.jsx("div",{className:"text-slate-600 dark:text-slate-300",children:"Chọn một câu ở danh sách bên trái để chỉnh sửa."})})]})]})}export{_e as default};
