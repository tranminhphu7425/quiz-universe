import{c as R,w as U,r as d,x as W,j as e,L as Y,m as E,f as P}from"./index-Di18Kthl.js";import{a as ee,u as te}from"./questionsApi-Bd07Af2O.js";import{C as se}from"./circle-check-j9XxwVSO.js";import{R as $}from"./refresh-ccw-Cuv4bdAr.js";import{P as ae}from"./plus-DlhqwwTq.js";import{T as ne}from"./trash-2-D6d3i9f_.js";const re=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],le=R("arrow-left",re);const ie=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],de=R("save",ie),oe=/\.{5,}/g;function w(l){const h=[];let m=0,x;for(;(x=oe.exec(l))!==null;){const c=x.index;c>m&&h.push({type:"text",text:l.slice(m,c)}),h.push({type:"blank"}),m=c+x[0].length}return m<l.length&&h.push({type:"text",text:l.slice(m)}),h.length?h:[{type:"text",text:l}]}function j(l){return structuredClone?structuredClone(l):JSON.parse(JSON.stringify(l))}const ce="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");function g(l){return ce[l]||`Opt${l+1}`}function be(){const{subjectId:l}=U(),[h,m]=d.useState(!0),[x,c]=d.useState(null),[H,V]=d.useState(""),[u,C]=d.useState([]),[b,T]=d.useState(1),y=10,[f,S]=d.useState(null);d.useMemo(()=>u.find(t=>t.id===f)||null,[u,f]);const[s,i]=d.useState(null),[O,_]=d.useState(!1),[q,p]=d.useState(null),M=d.useRef(null);d.useEffect(()=>{if(!l)return;let t=!1;return m(!0),c(null),(async()=>{try{const a=Number(l),[n,r]=await Promise.all([ee(a),W(a).catch(()=>({name:`Môn #${a}`}))]);t||(C(n),V(r?.name||`Môn #${a}`),n.length&&(S(n[0].id),i(j(n[0]))))}catch(a){t||c(a?.message||"Không tải được dữ liệu.")}finally{t||m(!1)}})(),()=>{t=!0}},[l]);const N=u.length,v=Math.max(1,Math.ceil(N/y)),k=(b-1)*y,I=Math.min(N,k+y),z=u.slice(k,I);function A(t){S(t.id),i(j(t)),p(null),setTimeout(()=>M.current?.scrollIntoView({behavior:"smooth",block:"start"}),0)}function B(t){if(!s)return;const a={...s,stem:t};i(a)}function Q(t){s&&i({...s,explanation:t})}function L(t){s&&i({...s,questionType:t})}function K(){if(!s)return;const t=(s.options||[]).slice().sort((r,o)=>(r.sortOrder??0)-(o.sortOrder??0)),a=t.length,n={id:Math.floor(Math.random()*1e9)*-1,questionId:s.id,label:g(a),content:"",isCorrect:s.questionType==="mcq_single"?a===0:!1,sortOrder:a+1};i({...s,options:[...t,n]})}function D(t){if(!s)return;const n=(s.options||[]).filter(r=>r.id!==t).slice().sort((r,o)=>(r.sortOrder??0)-(o.sortOrder??0)).map((r,o)=>({...r,label:g(o),sortOrder:o+1}));i({...s,options:n})}function F(t,a){if(!s)return;const n=(s.options||[]).map(r=>r.id===t?{...r,...a}:r);i({...s,options:n})}function G(t){if(!s||s.questionType!=="mcq_single")return;const a=(s.options||[]).map(n=>({...n,isCorrect:n.id===t}));i({...s,options:a})}function J(){if(!s)return;const t=w(s.stem).filter(n=>n.type==="blank").length;let a=(s.options||[]).slice().sort((n,r)=>(n.sortOrder??0)-(r.sortOrder??0));for(;a.length<t;){const n=a.length;a.push({id:Math.floor(Math.random()*1e9)*-1,questionId:s.id,label:g(n),content:"",isCorrect:!1,sortOrder:n+1})}a.length>t&&(a=a.slice(0,t)),a=a.map((n,r)=>({...n,label:g(r),sortOrder:r+1})),i({...s,options:a})}function X(){if(!s)return"Không có dữ liệu để lưu.";if(!s.stem?.trim())return"Vui lòng nhập nội dung câu hỏi (stem).";const t=(s.options||[]).slice();if(s.questionType==="mcq_single"){if(t.length<2)return"Cần ít nhất 2 lựa chọn cho câu trắc nghiệm.";if(t.filter(n=>n.isCorrect).length!==1)return"Câu trắc nghiệm phải có đúng 1 đáp án đúng."}if(s.questionType==="fill_in"){const a=w(s.stem).filter(n=>n.type==="blank").length;if(a===0)return"Câu điền khuyết cần có ít nhất 1 ô trống (gõ ≥ 6 dấu chấm).";if(t.length!==a)return`Số đáp án (${t.length}) chưa khớp số ô trống (${a}). Bấm "Đồng bộ ô trống".`;if(t.some(n=>!String(n.content||"").trim()))return"Mỗi ô trống cần cung cấp đáp án đúng (có thể nhiều phương án, ngăn bởi dấu |)."}return null}async function Z(){const t=X();if(t){p(null),c(t);return}if(s){_(!0),c(null),p(null);try{const a={stem:s.stem,explanation:s.explanation??null,questionType:s.questionType,options:(s.options||[]).slice().sort((r,o)=>(r.sortOrder??0)-(o.sortOrder??0)).map(r=>({id:r.id>0?r.id:void 0,label:r.label,content:r.content,isCorrect:!!r.isCorrect,sortOrder:r.sortOrder}))},n=await te(s.id,a);C(r=>r.map(o=>o.id===n.id?n:o)),i(j(n)),p("Đã lưu thay đổi.")}catch(a){c(a?.message||"Lưu thất bại.")}finally{_(!1),setTimeout(()=>p(null),2500)}}}return e.jsxs("div",{className:"min-h-screen bg-slate-50 dark:bg-slate-900",children:[e.jsxs("section",{className:"relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-600 via-green-600 to-emerald-500 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900"}),e.jsxs("div",{className:"relative z-10 mx-auto flex max-w-7xl flex-col gap-4 px-6 py-10 text-white md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-2 inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold ring-1 ring-white/20 backdrop-blur",children:"Trình chỉnh sửa câu hỏi"}),e.jsxs("h1",{className:"text-[1.9rem] md:text-[2.4rem] font-black leading-tight",children:["Sửa câu hỏi môn ",e.jsx("span",{className:"bg-gradient-to-r from-purple-300 to-amber-200 bg-clip-text text-transparent",children:H})]})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs(Y,{to:`/questions/subject/${l}`,className:"inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm ring-1 ring-white/20 hover:bg-white/15",children:[e.jsx(le,{className:"h-4 w-4"}),"Về trang làm bài"]})})]})]}),e.jsxs("main",{className:"mx-auto grid max-w-7xl grid-cols-1 gap-6 px-6 py-8 md:grid-cols-[minmax(280px,360px)_1fr]",children:[e.jsxs(E.aside,{initial:{opacity:0,x:-8},animate:{opacity:1,x:0},transition:{type:"spring",stiffness:140,damping:18},className:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-slate-200",children:"Danh sách câu hỏi"}),e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:[N," câu"]})]}),h?e.jsxs("div",{className:"flex items-center gap-2 text-slate-500",children:[e.jsx(P,{className:"h-4 w-4 animate-spin"}),"Đang tải…"]}):x?e.jsx("div",{className:"rounded-lg bg-rose-50 p-3 text-sm text-rose-700 ring-1 ring-rose-200 dark:bg-rose-900/20 dark:text-rose-300 dark:ring-rose-800",children:x}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-auto pr-1",children:e.jsx("ol",{className:"space-y-2",children:z.map((t,a)=>{const n=k+a+1,r=t.id===f;return e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>A(t),className:`w-full rounded-xl border px-3 py-2 text-left text-sm transition ${r?"border-emerald-400 bg-emerald-50 ring-1 ring-emerald-300 dark:border-emerald-700 dark:bg-emerald-900/20 dark:ring-emerald-800":"border-slate-200 hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800"}`,title:`Sửa câu ${n}`,children:[e.jsxs("div",{className:"mb-1 flex items-center gap-2 text-[13px] font-semibold text-slate-700 dark:text-slate-200",children:[e.jsx("span",{className:"inline-flex h-5 w-5 items-center justify-center rounded-md bg-slate-100 text-xs text-slate-700 dark:bg-slate-800 dark:text-slate-300",children:n}),e.jsx("span",{className:"truncate",children:t.stem})]}),e.jsx("div",{className:"text-[12px] text-slate-500 dark:text-slate-400",children:t.questionType==="fill_in"?"Điền khuyết":"Trắc nghiệm"})]})},t.id)})})}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("button",{onClick:()=>T(t=>Math.max(1,t-1)),disabled:b===1,className:"rounded-md border border-slate-200 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800",children:"← Trước"}),e.jsxs("div",{className:"text-xs text-slate-600 dark:text-slate-300",children:["Trang ",e.jsx("b",{children:b}),"/        ",e.jsx("b",{children:v})," • Câu ",e.jsx("b",{children:k+1}),"–        ",e.jsx("b",{children:I})]}),e.jsx("button",{onClick:()=>T(t=>Math.min(v,t+1)),disabled:b===v,className:"ml-auto rounded-md border border-slate-200 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800",children:"Sau →"})]})]})]}),e.jsxs(E.section,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{type:"spring",stiffness:140,damping:18},className:"rounded-2xl border border-emerald-100 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900",children:[e.jsx("div",{ref:M}),s?e.jsxs("form",{className:"space-y-5",onSubmit:t=>{t.preventDefault(),Z()},children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"text-sm font-semibold text-slate-700 dark:text-slate-200",children:["Câu #",f]}),q&&e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2 py-1 text-xs text-emerald-700 ring-1 ring-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-300 dark:ring-emerald-800",children:[e.jsx(se,{className:"h-3.5 w-3.5"}),q]}),x&&e.jsx("span",{className:"inline-flex items-center gap-1 rounded-full bg-rose-100 px-2 py-1 text-xs text-rose-700 ring-1 ring-rose-200 dark:bg-rose-900/30 dark:text-rose-300 dark:ring-rose-800",children:x})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Loại câu hỏi"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200",children:[e.jsx("input",{type:"radio",name:"type",value:"mcq_single",checked:s.questionType==="mcq_single",onChange:()=>L("mcq_single"),className:"h-4 w-4 accent-emerald-700"}),"Trắc nghiệm 1 đáp án đúng"]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200",children:[e.jsx("input",{type:"radio",name:"type",value:"fill_in",checked:s.questionType==="fill_in",onChange:()=>L("fill_in"),className:"h-4 w-4 accent-emerald-700"}),"Điền khuyết (….. = ô trống)"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Nội dung câu hỏi (Stem)"}),e.jsx("textarea",{value:s.stem,onChange:t=>B(t.target.value),rows:3,className:"w-full resize-y rounded-xl border border-slate-300 bg-white p-3 text-sm outline-none ring-emerald-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100",placeholder:s.questionType==="fill_in"?"Ví dụ: 1 + ….. = ….. (dùng ≥ 6 dấu chấm để tạo ô trống)":"Nhập câu hỏi"}),s.questionType==="fill_in"&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-slate-600 dark:text-slate-400",children:["Có ",e.jsx("b",{className:"mx-1",children:w(s.stem).filter(t=>t.type==="blank").length})," ô trống.",e.jsxs("button",{type:"button",onClick:J,className:"inline-flex items-center gap-1 rounded-md border px-2 py-1 text-[12px] hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800",children:[e.jsx($,{className:"h-3.5 w-3.5"}),"Đồng bộ ô trống"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Giải thích (tuỳ chọn)"}),e.jsx("textarea",{value:s.explanation||"",onChange:t=>Q(t.target.value),rows:3,className:"w-full resize-y rounded-xl border border-slate-300 bg-white p-3 text-sm outline-none ring-emerald-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100",placeholder:"Nhập giải thích/ghi chú cho câu hỏi"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-200",children:"Phương án trả lời"}),e.jsxs("button",{type:"button",onClick:K,className:"inline-flex items-center gap-1 rounded-md border px-2 py-1 text-sm hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800",children:[e.jsx(ae,{className:"h-4 w-4"}),"Thêm lựa chọn"]})]}),e.jsx("div",{className:"space-y-2",children:(s.options||[]).slice().sort((t,a)=>(t.sortOrder??0)-(a.sortOrder??0)).map((t,a)=>e.jsxs("div",{className:"flex items-start gap-2 rounded-xl border border-slate-200 p-3 dark:border-slate-800",children:[e.jsx("div",{className:"mt-1 inline-flex h-6 w-6 items-center justify-center rounded-md bg-slate-100 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-300",children:t.label||g(a)}),e.jsxs("div",{className:"grid flex-1 gap-2 md:grid-cols-[1fr_auto]",children:[e.jsx("input",{type:"text",value:t.content||"",onChange:n=>F(t.id,{content:n.target.value}),placeholder:s.questionType==="fill_in"?'Đáp án đúng cho ô này (có thể "a|b|c")':"Nội dung phương án",className:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm outline-none ring-emerald-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100"}),s.questionType==="mcq_single"?e.jsxs("label",{className:"inline-flex items-center justify-end gap-2 text-sm text-slate-700 dark:text-slate-200",children:[e.jsx("input",{type:"radio",name:"correct",checked:!!t.isCorrect,onChange:()=>G(t.id),className:"h-4 w-4 accent-emerald-700"}),"Đúng"]}):e.jsx("div",{className:"text-right text-[12px] text-slate-500 dark:text-slate-400 self-center",children:"(Tự động chấm theo văn bản)"})]}),e.jsx("button",{type:"button",onClick:()=>D(t.id),className:"rounded-md p-2 text-slate-500 hover:bg-slate-100 hover:text-rose-600 dark:hover:bg-slate-800",title:"Xoá",children:e.jsx(ne,{className:"h-4 w-4"})})]},t.id))}),s.questionType==="fill_in"&&e.jsxs("p",{className:"mt-2 text-[12px] text-slate-600 dark:text-slate-400",children:["Mẹo: Cho phép nhiều đáp án cho một ô bằng dấu ",e.jsx("code",{className:"rounded bg-slate-100 px-1 dark:bg-slate-800",children:"|"}),", ví dụ: ",e.jsx("code",{className:"rounded bg-slate-100 px-1 dark:bg-slate-800",children:'"Hà Nội|Ha Noi"'}),"."]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("button",{type:"submit",disabled:O,className:"inline-flex items-center gap-2 rounded-full bg-emerald-600 px-5 py-2.5 text-white shadow hover:brightness-110 disabled:opacity-70",children:[O?e.jsx(P,{className:"h-4 w-4 animate-spin"}):e.jsx(de,{className:"h-4 w-4"})," Lưu thay đổi"]}),e.jsxs("button",{type:"button",onClick:()=>s?i(j(u.find(t=>t.id===s.id))):null,className:"inline-flex items-center gap-2 rounded-full bg-slate-800 px-5 py-2.5 text-white shadow hover:brightness-110 dark:bg-slate-700",children:[e.jsx($,{className:"h-4 w-4"}),"Hoàn tác"]})]}),e.jsx("button",{className:"inline-flex items-center gap-2 rounded-full bg-yellow-500 px-5 py-2.5 text-white shadow hover:brightness-110 dark:bg-yellow-600",children:"Tạo thêm câu hỏi"})]})]}):e.jsx("div",{className:"text-slate-600 dark:text-slate-300",children:"Chọn một câu ở danh sách bên trái để chỉnh sửa."})]})]})]})}export{be as default};
